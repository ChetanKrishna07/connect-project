<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Chat</title>
    <link rel="stylesheet" href="newNav.css" />
    <link rel="stylesheet" href="messages.css" />
    <link
      href="https://fonts.googleapis.com/css2?family=Poppins&display=swap"
      rel="stylesheet"
    />
  </head>

  <body>
    <nav>
      <ul id="logo-name" class="logo-name">
        <li><span>CONNECT</span></li>
        <img id="logo" src="images/logo.jpg" alt="logo" />
      </ul>
      <ul class="link-match" id="link-match">
        <li>
          <input
            type="search"
            name="search-box-frnd"
            id="search-box-frnd"
            placeholder="Search Users"
          />
        </li>
        <li><a href="home.html">Home</a></li>
        <li><a href="ProfilePage.html">Profile</a></li>
        <li><a href="messages.html">Messages</a></li>
        <li><a href="login.html" id="logout">Logout</a></li>
      </ul>
      <ul class="menu">
        <li>
          <a href="javascript:void(0);" id="menu" onclick="open_close()">â˜°</a>
        </li>
      </ul>
    </nav>

    <div class="chat-container">
      <div class="left-container" id="convoList">
        <img class="dp" src="images/amelia.jpg" alt="" id="dp" />
        <br />
        <input
          type="text"
          placeholder="Search Contacts..."
          name="search_chat"
          id="search_chat"
        />
        <br />

        <!-- <div class="eachChat">
          <img class="dp-chat" src="images/emma.jpg" alt="" />
          <h4 id="name">Emma</h4>
          <p id="time">9:52</p>
          <p id="msg">Good Morning</p>
        </div>

        <div class="eachChat">
          <img class="dp-chat" src="images/amelia.jpg" alt="" />
          <h4 id="name">Amelia</h4>
          <p id="time">8:43</p>
          <p id="msg">Bye</p>
        </div>

        <div class="eachChat">
          <img class="dp-chat" src="images/sophia.jpg" alt="" />
          <h4 id="name">Sophia</h4>
          <p id="time">4:29</p>
          <p id="msg">nice to meet u</p>
        </div>

        <div class="eachChat">
          <img class="dp-chat" src="images/emma.jpg" alt="" />
          <h4 id="name">Emma</h4>
          <p id="time">9:52</p>
          <p id="msg">Good Morning</p>
        </div>

        <div class="eachChat">
          <img class="dp-chat" src="images/amelia.jpg" alt="" />
          <h4 id="name">Amelia</h4>
          <p id="time">8:43</p>
          <p id="msg">Bye</p>
        </div>

        <div class="eachChat">
          <img class="dp-chat" src="images/sophia.jpg" alt="" />
          <h4 id="name">Sophia</h4>
          <p id="time">4:29</p>
          <p id="msg">nice to meet u</p>
        </div>

        <div class="eachChat">
          <img class="dp-chat" src="images/emma.jpg" alt="" />
          <h4 id="name">Emma</h4>
          <p id="time">9:52</p>
          <p id="msg">Good Morning</p>
        </div>

        <div class="eachChat">
          <img class="dp-chat" src="images/amelia.jpg" alt="" />
          <h4 id="name">Amelia</h4>
          <p id="time">8:43</p>
          <p id="msg">Bye</p>
        </div>

        <div class="eachChat">
          <img class="dp-chat" src="images/sophia.jpg" alt="" />
          <h4 id="name">Sophia</h4>
          <p id="time">4:29</p>
          <p id="msg">nice to meet u</p>
        </div>

        <div class="eachChat">
          <img class="dp-chat" src="images/emma.jpg" alt="" />
          <h4 id="name">Emma</h4>
          <p id="time">9:52</p>
          <p id="msg">Good Morning</p>
        </div>

        <div class="eachChat">
          <img class="dp-chat" src="images/amelia.jpg" alt="" />
          <h4 id="name">Amelia</h4>
          <p id="time">8:43</p>
          <p id="msg">Bye</p>
        </div>

        <div class="eachChat">
          <img class="dp-chat" src="images/sophia.jpg" alt="" />
          <h4 id="name">Sophia</h4>
          <p id="time">4:29</p>
          <p id="msg">nice to meet u</p>
        </div> -->
      </div>

      <div class="right-container">
        <div class="chatName" id="chatName">
          <!-- <img id="chat-img" src="images/sophia.jpg" alt="" />
          <h4 id="chat-name">Sophia</h4> -->
        </div>

        <div class="chatting" id="chatting">
          <!-- <p class="myMsg">Hi! Shyam. How are you?</p>
          <p class="frndMsg">Hi! Ram. I am good. What about you.</p>
          <p class="myMsg">
            Yeah. I am also good. How was your result? I got 93.9%.
          </p>
          <p class="myMsg">Mine was also good. I got 99.2 %.</p>
          <p class="frndMsg">
            Wow! then definitely you are going to join an engineering college.
          </p>
          <p class="frndMsg">Yes! definitely. What about you?</p>
          <p class="frndMsg">
            Lorem ipsum dolor sit amet, consectetur adipisicing elit. A dolor
            magnam molestiae deleniti minus qui, excepturi accusantium
            recusandae culpa? Neque tempore impedit non officiis veritatis
            maxime pariatur expedita alias ipsum!
          </p>
          <p class="myMsg">Hi! Shyam. How are you?</p>
          <p class="frndMsg">Hi! Ram. I am good. What about you.</p>
          <p class="myMsg">
            Yeah. I am also good. How was your result? I got 93.9%.
          </p>
          <p class="myMsg">Mine was also good. I got 99.2 %.</p>
          <p class="frndMsg">
            Wow! then definitely you are going to join an engineering college.
          </p>
          <p class="frndMsg">Yes! definitely. What about you?</p>
          <p class="myMsg">Hi! Shyam. How are you?</p>
          <p class="frndMsg">Hi! Ram. I am good. What about you.</p>
          <p class="myMsg">
            Yeah. I am also good. How was your result? I got 93.9%.
          </p>
          <p class="myMsg">Mine was also good. I got 99.2 %.</p>
          <p class="frndMsg">
            Wow! then definitely you are going to join an engineering college.
          </p>
          <p class="frndMsg">Yes! definitely. What about you?</p>
        </div> -->
      </div>
      <div class="chatText hidden" id="sendMsg">
        <input
          type="text"
          name="txtmsg"
          id="txtmsg"
          placeholder="Type a message"
        />
        <ion-icon name="send-outline" id="send"></ion-icon>
      </div>
    </div>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <script
      type="module"
      src="https://unpkg.com/ionicons@5.5.2/dist/ionicons/ionicons.esm.js"
    ></script>
    <script
      nomodule
      src="https://unpkg.com/ionicons@5.5.2/dist/ionicons/ionicons.js"
    ></script>
    <script src="loginCheck.js"></script>

    <script>
      const uid = sessionStorage.getItem("uname");

      setInterval(() => {
        document.getElementById(sessionStorage.getItem('current')).click()
      }, 2000)

      var openChat = (e) => {
        console.log(e);
      }
      var getUserDatails = async () => {
        let headersList = {
          "Content-Type": "application/json",
        };

        let body = {
          uid: uid,
        };

        let getOptions = {
          url: "http://localhost:3000/getuserdetails",
          method: "POST",
          headers: headersList,
          data: body,
        };

        var userDetails = await axios.request(getOptions);
        const user = userDetails.data;
        console.log(user);

        // document.getElementById("name").innerHTML = user.uid;
        // document.getElementById("country").innerHTML = user.country;
        // document.getElementById("country2").innerHTML = user.country;
        // document.getElementById("about").innerHTML = user.about;
        // document.getElementById("birthday").innerHTML = user.birthday;
        // document.getElementById("mobile").innerHTML = user.mobile;
        // document.getElementById("blood_group").innerHTML = user.blood_group;
        // document.getElementById("gender").innerHTML = user.gender;
        // document.getElementById("occupation").innerHTML = user.occupation;
        // document.getElementById("email").innerHTML = user.email;
        // document.getElementById("hobbies").innerHTML = user.hobbies;
        // document.getElementById("education").innerHTML = user.education;
        // document.getElementById("other").innerHTML = user.other;
        // document.getElementById("workExp").innerHTML = user.workExp;
        // document.getElementById("friends").innerHTML = user.friends.length;

        if (user.dp != null) {
          document.getElementById("dp").src = user.dp;
        }

        let convoHTML = "";

        let convos = await axios.request({
          url: "http://localhost:3000/getConvos",
          method: "POST",
          headers: headersList,
          data: {
            uid: uid,
          },
        });

        convos = convos.data;

        for (var convo of convos) {
          var members = convo.members;
          // console.log(uid);
          var friend = members.filter((f) => f != uid)[0];
          console.log(friend);
          let img = await axios.request({
            url: "http://localhost:3000/getDp",
            method: "POST",
            headers: headersList,
            data: {
              uid: friend,
            },
          });

          let lastChat = convo.chats[convo.chats.length - 1].body;

          convoHTML += `<div class="eachChat" id=${convo._id} name=${friend}>
          <img class="dp-chat" src="${img.data}" alt="" id=${convo._id}/>
          <h4 id="name">${friend}</h4>
          <p id="time">8:43</p>
          <p id="msg">${lastChat}</p>
        </div>`;
        }

        document.getElementById("convoList").innerHTML += convoHTML;

        document.getElementById('send').addEventListener('click', async ()=> {
              let body = document.getElementById('txtmsg').value
              let convo = sessionStorage.getItem('current')
              // console.log(convo);
              // console.log(body);
              let res = await axios.request({
                url: "http://localhost:3000/addChat",
                method: "POST",
                headers: headersList,
                data: {
                  cid: convo,
                  sender: uid,
                  body: body
                },
              })
              console.log(res.data);
              document.getElementById(convo).click()
        })

        for(convo of convos) {

          document.getElementById(convo._id).addEventListener('click', async (e) => {
            document.getElementById('sendMsg').classList.remove('hidden')
            let id = e.target.id
            sessionStorage.setItem('current', id)
            let c = await axios.request({
              url: "http://localhost:3000/getChats",
              method: "POST",
              headers: headersList,
              data: {
                cid: id,
              },
            })
            let chats = c.data
            var members = chats.members;
          // console.log(uid);
            var friend = members.filter((f) => f != uid)[0];
            console.log(friend);
            let img = await axios.request({
              url: "http://localhost:3000/getDp",
              method: "POST",
              headers: headersList,
              data: {
                uid: friend,
              },
            });
              document.getElementById('chatName').innerHTML = `
              <img id="chat-img" src=${img.data} alt="" />
             <h4 id="chat-name">${friend}</h4>`
              var chatHTML = ''
              console.log(uid);
             for(chat of chats.chats) {
              if(chat.sender == uid) {
                chatHTML += `<p class="myMsg">${chat.body}</p>`
              } else {
                chatHTML += `<p class="frndMsg">${chat.body}</p>`
              }
             }
             document.getElementById('chatting').innerHTML = chatHTML
          })
        }

        // for (friend of friends) {
        //   let img = await axios.request({
        //     url: "http://localhost:3000/getDp",
        //     method: "POST",
        //     headers: headersList,
        //     data: {
        //       uid: friend,
        //     },
        //   });

        //   friendHTML += `<div class="frnd">
        //       <img src=${img.data} alt="profile" />
        //       <p>${friend}</p>
        //     </div>`;
        // }

        // document.getElementById("friendList").innerHTML = friendHTML;
      };

      getUserDatails();
    </script>
  </body>
</html>
